<!DOCTYPE html>
<html lang="en">
<head>
  <title>Heatmap test</title>
  <meta charset="UTF-8">
  
  <style>
    body {
      font-family: sans-serif;
    }
  </style>
  <script src="../modules/node_modules/d3/build/d3.js"></script>
  <script src="../modules/dist/bvu.js"></script>
</head>
  <body>
    <script>
      d3.csv("data.csv", function(data) {
        data = data.map(function(d) {
          return {
            DayOfWeek: +d.DayOfWeek,
            DepDelay: +d.DepDelay,
            DepTimeBlk: d.DepTimeBlk,
            StdMeanErr: +d.StdMeanErr
          }
        });

        var quantization = bvu.quantization().branching(2).layers(4);

        var scale = bvu.scale().range(d3.interpolateViridis);

        var squareQuantization = bvu.squareQuantization().n(4);
        var squareScale = bvu.scale().quantize(squareQuantization).range(d3.interpolateViridis);

        var body = d3.select('body');
        makeFlightExample(body.append("svg"), quantization, scale, data, "arc");
        makeFlightExample(body.append("svg"), squareQuantization, squareScale, data, "square");
      });

      function makeFlightExample(svg, quantization, scale, data, type) {
        var w = 560;
        var h = 240;

        var x = d3.scaleBand().range([0, w]).domain(data.map(function(d) { return d.DepTimeBlk; }));
        var y = d3.scaleBand().range([0, h]).domain(data.map(function(d) { return d.DayOfWeek; }));

        // TODO: this seems to be the wrong place to do this mapping
        var u = d3.scaleLinear().range([0, 1]).domain(d3.extent(data.map(function(d) { return d.StdMeanErr; })));
        var v = d3.scaleLinear().range([0, 1]).domain(d3.extent(data.map(function(d) { return d.DepDelay; })));

        // special scales for axes
        var xAxis = d3.scalePoint().range([0, w]).domain([0, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]);
        var yAxis = d3.scaleBand().range([0, h]).domain(["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]);

        var heatmap = svg.attr("width", w + 350).attr("height", h + 60).append("g")
                  .attr("transform", "translate(10,10)");

        heatmap.selectAll("rect")
          .data(data)
          .enter()
          .append("rect")
          .attr("x", function(d) { return x(d.DepTimeBlk); })
          .attr("y", function(d) { return y(d.DayOfWeek); })
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .attr("title", JSON.stringify)
          .attr("fill", function(d) { return scale(v(d.DepDelay), u(d.StdMeanErr)); });

        // axes
        heatmap.append("g")
          .attr("transform", "translate(0," + h + ")")
          .call(d3.axisBottom(xAxis));

        heatmap.append("text")
          .style("text-anchor", "middle")
          .style("font-size", 13)
          .attr("transform", "translate(" + (w / 2) + ", " + (h + 40) + ")")
          .text("Departure Time")

        heatmap.append("g")
          .attr("transform", "translate(" + w + ", 0)")
          .call(d3.axisRight(yAxis));

        heatmap.append("text")
          .style("text-anchor", "middle")
          .style("font-size", 13)
          .attr("transform", "translate(" + (w + 80) + ", " + (h / 2) + ")rotate(90)")
          .text("Day of the Week");

        // legend
        var legendX = w + 140;
        var legend;

        if (type === "arc") {
          var legendData = [];
          var temp = quantization.tree();
          for(var i = 0; i < temp.length; i++) {
            legendData[i] = temp[temp.length-i-1];
          }

          legend = bvu.legend.arcmapLegend()
            .data(legendData)
            .scale(scale);
        } else {
          var legendData = [];
          temp = quantization.matrix();
          for(var i = 0; i < temp.length; i++) {
            legendData[i] = temp[temp.length-i-1];
          }

          legend = bvu.legend.heatmapLegend()
            .data(legendData)
            .scale(scale);
        }

        legend
          .size(160)
          .x(legendX)
          .y(60).utitle("Standard Mean Error")
          .vtitle("Departure Delay (minutes)");

        svg.append("g").call(legend)
      }
    </script>
  </body>
</html>
